<div class="inbox-container">
  <div class="background-pattern"></div>
  <div class="floating-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
    <div class="shape shape-4"></div>
    <div class="shape shape-5"></div>
  </div>
  <nav class="top-navbar">
    <div class="navbar-content">
      <div class="navbar-brand-section">
        <div class="brand-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="52 42 88 66" class="gmail-logo">
            <path fill="#4285f4" d="M58 108h14V74L52 59v43c0 3.32 2.69 6 6 6"/>
            <path fill="#34a853" d="M120 108h14c3.32 0 6-2.69 6-6V59l-20 15"/>
            <path fill="#fbbc04" d="M120 48v26l20-15v-8c0-7.42-8.47-11.65-14.4-7.2"/>
            <path fill="#ea4335" d="M72 74V48l24 18 24-18v26L96 92"/>
            <path fill="#c5221f" d="M52 51v8l20 15V48l-5.6-4.2c-5.94-4.45-14.4-.22-14.4 7.2"/>
          </svg>
        </div>
        <div class="brand-text">
          <h1 class="brand-title">Gmail Action Bot</h1>
          <p class="brand-subtitle">AI-Powered Gmail Management</p>
        </div>
      </div>
      
      <div class="gmail-ai-badge-wrapper">
        <div class="gmail-ai-badge">
          <div class="badge-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="52 42 88 66" class="gmail-logo-small">
              <path fill="#4285f4" d="M58 108h14V74L52 59v43c0 3.32 2.69 6 6 6"/>
              <path fill="#34a853" d="M120 108h14c3.32 0 6-2.69 6-6V59l-20 15"/>
              <path fill="#fbbc04" d="M120 48v26l20-15v-8c0-7.42-8.47-11.65-14.4-7.2"/>
              <path fill="#ea4335" d="M72 74V48l24 18 24-18v26L96 92"/>
              <path fill="#c5221f" d="M52 51v8l20 15V48l-5.6-4.2c-5.94-4.45-14.4-.22-14.4 7.2"/>
            </svg>
          </div>
          <div class="badge-content">
            <span class="badge-label">AI-POWERED</span>
            <span class="badge-subtitle">Gmail Assistant</span>
          </div>
        </div>
        <a 
          href="https://myaccount.google.com/permissions" 
          target="_blank" 
          rel="noopener noreferrer"
          class="remove-access-link">
          <i class="bi bi-shield-x"></i>
          <span>Remove Access</span>
          <i class="bi bi-box-arrow-up-right external-icon"></i>
        </a>
        <div class="info-button-container">
          <button class="info-button" (click)="toggleInfoPopup($event)">
            <i class="bi bi-info-circle"></i>
          </button>
          <div class="info-popup" *ngIf="showInfoPopup" (click)="$event.stopPropagation()">
            <div class="info-popup-content">
              <i class="bi bi-shield-check info-popup-icon"></i>
              <p>Your data is secure, encrypted, and never stored. If you want to remove Gmail access for this app, just click <strong>'Remove Access'</strong>, choose your Gmail account, and revoke the permission.</p>
            </div>
            <div class="info-popup-arrow"></div>
          </div>
        </div>
      </div>
      
      <div class="navbar-right">
        <div class="welcome-user">
          <i class="bi bi-person-circle"></i>
          <span>Welcome, {{ userName }}</span>
        </div>
        <button class="logout-button" (click)="logout()">
          <i class="bi bi-box-arrow-right"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div class="email-list-panel">
      <div class="panel-header">
        <div class="header-left">
          <div class="header-icon">
            <i class="bi bi-inbox-fill"></i>
          </div>
          <div>
            <h2 class="panel-title">Inbox</h2>
            <p class="panel-subtitle" *ngIf="!loadingEmails && emails.length > 0">
              {{ emails.length }} gmails
              <span class="mail-limit-info" *ngIf="emails.length >= 50">Primary inbox(Showing latest 50)</span>
              <span class="mail-limit-info" *ngIf="emails.length < 50">Primary inbox(All recent mails)</span>
            </p>
            <p class="panel-subtitle" *ngIf="!loadingEmails && emails.length === 0">
              No gmails
            </p>
          </div>
        </div>
        <button
          class="refresh-button"
          (click)="loadEmails()"
          [disabled]="loadingEmails"
          [class.loading]="loadingEmails">
          <i class="bi bi-arrow-clockwise" [class.spinning]="loadingEmails"></i>
        </button>
      </div>

      <!-- Classification Insights Bar - Always Visible -->
      <div class="classification-insights" *ngIf="!loadingEmails && emails.length > 0">
        <div class="insights-header">
          <i class="bi bi-robot"></i>
          <span>AI Insights</span>
          <span class="classified-count" *ngIf="!classifying && getClassifiedCount() > 0">
            {{ getClassifiedCount() }}/{{ emails.length }} classified
          </span>
          <span class="classifying-status" *ngIf="classifying">
            <span class="mini-spinner"></span>
            Classifying {{ classifyingProgress }}/{{ emails.length }}...
          </span>
        </div>
        
        <!-- Progress bar while classifying -->
        <div class="classify-progress-bar" *ngIf="classifying">
          <div class="progress-fill" [style.width.%]="(classifyingProgress / emails.length) * 100"></div>
        </div>
        
        <div class="insights-categories" *ngIf="!classifying || getClassifiedCount() > 0">
          <div *ngFor="let cat of getCategorySummary()" 
               class="insight-chip clickable"
               [ngClass]="'chip-' + cat.class"
               [class.active]="selectedCategory === cat.name"
               (click)="selectCategory(cat.name)"
               title="Click to view {{ cat.name }} emails">
            <i class="bi" [ngClass]="cat.icon"></i>
            <span class="chip-count">{{ cat.count }}</span>
            <span class="chip-name">{{ cat.name }}</span>
          </div>
          <button *ngIf="selectedCategory" 
                  class="clear-filter-btn"
                  (click)="clearCategoryFilter()">
            <i class="bi bi-x"></i>
            Clear
          </button>
          <div *ngIf="!classifying && getClassifiedCount() === 0" class="insight-hint">
            <i class="bi bi-hourglass-split"></i>
            Classification starting...
          </div>
        </div>
      </div>

      <div class="panel-body">
        <div *ngIf="loadingEmails" class="loading-state">
          <div class="spinner"></div>
          <p>Loading gmails...</p>
        </div>

        <div *ngIf="error && !loadingEmailDetail" class="error-alert">
          <i class="bi bi-exclamation-triangle"></i>
          <span>{{ error }}</span>
        </div>

        <div *ngIf="!loadingEmails && emails.length === 0" class="empty-state">
          <div class="empty-icon">
            <i class="bi bi-inbox"></i>
          </div>
          <p class="empty-text">No gmails found</p>
          <p class="empty-subtext">Your inbox is empty</p>
        </div>

        <!-- Filter indicator -->
        <div *ngIf="selectedCategory" class="filter-indicator">
          <i class="bi bi-funnel-fill"></i>
          <span>Showing <strong>{{ selectedCategory }}</strong> emails ({{ getFilteredEmails().length }})</span>
        </div>

        <div class="email-list" *ngIf="!loadingEmails">
          <div
            *ngFor="let email of getFilteredEmails(); let i = index"
            class="email-item"
            [class.active]="selectedEmail?.id === email.id"
            [class.classified]="emailCategories[email.id]"
            (click)="selectEmail(email)"
            [style.animation-delay]="i * 0.02 + 's'">
            <div class="email-avatar" [ngClass]="emailCategories[email.id] ? 'avatar-' + getCategoryClass(emailCategories[email.id]) : ''">
              <span *ngIf="!emailCategories[email.id]">{{ email.from.charAt(0).toUpperCase() }}</span>
              <i *ngIf="emailCategories[email.id]" class="bi" [ngClass]="getCategoryIcon(emailCategories[email.id])"></i>
            </div>
            <div class="email-content">
              <div class="email-header">
                <div class="email-from">{{ email.from }}</div>
                <div class="email-date">{{ formatDate(email.date) }}</div>
              </div>
              <div class="email-subject-row">
                <span class="email-subject">{{ email.subject || '(No Subject)' }}</span>
                <span *ngIf="emailCategories[email.id]" 
                      class="email-category-tag"
                      [ngClass]="'tag-' + getCategoryClass(emailCategories[email.id])">
                  {{ emailCategories[email.id] }}
                </span>
              </div>
              <div class="email-snippet">{{ email.snippet }}</div>
            </div>
            <div class="email-indicator" *ngIf="selectedEmail?.id === email.id">
              <i class="bi bi-chevron-right"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="email-detail-panel">
      <div *ngIf="loadingEmailDetail" class="loading-overlay">
        <div class="spinner-large"></div>
          <p>Loading gmail...</p>
      </div>

      <div *ngIf="!selectedEmail && !loadingEmailDetail" class="empty-detail-state">
        <div class="empty-detail-icon">
          <i class="bi bi-envelope-open"></i>
        </div>
        <h3>Select a gmail</h3>
        <p>Choose a gmail from your inbox to view its details</p>
      </div>

      <app-email-detail
        *ngIf="selectedEmail && !loadingEmailDetail"
        [email]="selectedEmail"
        [userId]="userId!"
        (emailSent)="onEmailSent()">
      </app-email-detail>
    </div>
  </div>
</div>

